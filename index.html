<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>数据抓取</title>
    <link href="./layui/layui/css/layui.css" rel="stylesheet">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="./layui/layui/layui.all.js"></script>
    <style>
        body, html {
            height: 100%;
            }

        .close {
            display: none;
            }

        * {
            box-sizing: border-box;
            }

        #webview {
            border-bottom: 1px solid #CCCCCC;
            position: relative;
            }

        #webview::before {
            content: '';
            width: 100%;
            height: 100%;
            z-index: 100;
            position: absolute;
            top: 0;
            left: 0;
            }

        .item {
            width: 80px;
            line-height: 30px;
            background: orange;
            color: #FFFFFF;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            }

        .step > div {
            cursor: pointer;
            line-height: 40px;
            }

        webview {
            height: 600px;
            }

        #category {
            text-align: center;
            }

        #category .fl:first-child {
            border-bottom: 1px #CCCCCC solid;
            border-top: 1px solid #CCCCCC;
            min-height: 60px;
            }

        .step button {
            cursor: pointer;
            }
    </style>
</head>
<body>
<div id="close-browser" style="text-align: center;line-height:60px;">
    <button class="layui-btn">关闭浏览器</button>
</div>

<div id="webview">
    <webview src="https://m.weike.fm/cps/hotlist" nodeintegration plugins
             preload="renderer.js"></webview>
</div>

<div id="tips" style="color: green;text-align: center;line-height: 40px;">
</div>

<div>
    <table class="layui-table">
        <thead>
        <tr>
            <th>网站</th>
            <th>操作流程</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>千聊</td>
            <td id="qianliao-step">
                <button class="layui-btn layui-btn-normal" step="init">初始化环境</button>
                <button class="layui-btn layui-btn-normal" step="1">1.获取课程列表</button>
                <button class="layui-btn layui-btn-normal" step="2">2.转载所有课程</button>
                <button class="layui-btn layui-btn-normal" step="3">3.获取我已转载得课程</button>
                <button class="layui-btn layui-btn-normal" step="4">4.上传到服务器</button>
                <!--
                                <button class="layui-btn layui-btn-normal">获取千聊数据</button>
                -->
            </td>
        </tr>
        <tr>
            <td>荔枝微课</td>
            <td id="lizhi-step">
                <button class="layui-btn layui-btn-normal" data-step="init">初始化环境</button>
                <button class="layui-btn layui-btn-normal" data-step="1">1.获取课程列表</button>
                <button class="layui-btn layui-btn-normal" data-step="2">2.检查/添加分销渠道</button>
                <button class="layui-btn layui-btn-normal" data-step="3">3.获取我的渠道列表</button>
                <button class="layui-btn layui-btn-normal" data-step="4">4.获取教师信息</button>
                <button class="layui-btn layui-btn-normal" data-step="5">5.上传到服务器</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<script>
    let tips;
    const Excel = nodeRequire('exceljs');
    const {shell, dialog, app, ipRender, session} = nodeRequire('electron').remote;
    const clearCookies = nodeRequire('./clearCookies');
    const path = nodeRequire('path');
    let remote = nodeRequire('electron').remote;
    let store = remote.getGlobal('store');
    const fs = nodeRequire('fs');
    const {uploadJson} = nodeRequire('./assets/uploadJson');
    let {qianliaoHandle} = nodeRequire('./assets/qianliao/main');
    let qianliaoInstance;
    let webview;
    let remarks = '';
    let lizhiHandelInstance;

    window.onload = function () {
        webview = document.querySelector('webview');
        tips = document.getElementById('tips');

        //荔枝微课
        class LizhiHandle {
            constructor(webview) {
                this.createTransportIndex = 0;
                this.teacherIndex = 0;
                this.transportCount = 0;
                this.workbook = null;
                this.worksheet = null;
                this.webview = webview;
                this.courseList = [];
                this.myTransport = [];
                this.mergetmyTransportAndCourseList = [];
                this.finalData = [];
            }

            //单页课程获取完成
            getLizhiItem(arr, page) {
                this.courseList = this.courseList.concat(arr);
                tips.innerText = `第${page}页获取完成`;
                this.webview.loadURL(`https://m.weike.fm/cps/objlist?ot=r&order_by=ut&keyword=&st=&page=${page}`);
            }

            //所有课程获取完成
            getLizhiComplete(arr, callback) {
                const _this = this;
                this.courseList = this.courseList.concat(arr);
                this.page = 1;
                tips.innerText = `课程列表已获取完成共:${_this.courseList.length}条`;
                fs.writeFile('./assets/lizhi/results/list.json', JSON.stringify({data: _this.courseList}), (err) => {
                    if (err) throw err;
                    console.log(`荔枝课程获取完成共:${_this.courseList.length}`);
                    callback && callback(_this.arr);
                })
            }

            //检查是否是最终数据
            checkFinalData() {
                let filePath = path.join(process.cwd(), './assets/lizhi/results/Final.json');
                let filePathIsExits = fs.existsSync(filePath);
                let myTransport = filePathIsExits && JSON.parse(fs.readFileSync(filePath, {encoding: 'utf-8'})).data || [];
                if (myTransport.length) {
                    this.finalData = myTransport;
                }
                return myTransport.length;
            }

            //检查是否已经获取过课程
            checkIsHasCourseList() {
                let filePath = path.join(process.cwd(), 'assets/lizhi/results/list.json');
                let filePathIsExits = fs.existsSync(filePath);
                let courseList = filePathIsExits && JSON.parse(fs.readFileSync(filePath, {encoding: 'utf-8'})).data || [];
                if (courseList.length) {
                    this.courseList = courseList;
                }
                return courseList.length;
            }

            //检查是否获取过我的转载
            checkIsHasMyTransport() {
                let filePath = path.join(process.cwd(), './assets/lizhi/results/concat.json');
                let filePathIsExits = fs.existsSync(filePath);
                let concatList = filePathIsExits && JSON.parse(fs.readFileSync(filePath, {encoding: 'utf-8'})).data || [];
                if (concatList.length) {
                    this.mergetmyTransportAndCourseList = concatList;
                }
                return concatList.length;
            }


            //转载课程
            createTransport() {
                if (this.createTransportIndex == 0 && !this.courseList.length && !this.checkIsHasCourseList()) {
                    alert('请先获取所有课程列表再进行此操作');
                }
                if (this.createTransportIndex > 0) {
                    this.transportCount += 1;
                }
                if (this.createTransportIndex < this.courseList.length) {
                    let current = this.courseList[this.createTransportIndex];
                    this.webview.loadURL(`https://m.weike.fm/cps/cobjsid?pid=${current['promoteId']}&remarks=${remarks}`);
                    this.createTransportIndex = this.createTransportIndex + 1;
                    tips.innerText = `正在转载${current['courseName']}-(${this.createTransportIndex}/${this.courseList.length})`;
                } else {
                    tips.innerText = `课程已转载完成共转载${_this.transportCount}条`;
                    // document.getElementById('remarks').value = '';
                }
            }

            //我的转载单页数据获取完成
            getMyTransportItem(arr, page) {
                this.myTransport = this.myTransport.concat(arr);
                this.webview.loadURL(`https://m.weike.fm/cps/sourcelist?keyword=&end=2018-09-20&t=today&tab=all&beg=2018-09-20&page=${page}`)
            }

            //我的所有转载获取完成
            getMyTransportComplete(arr) {
                const _this = this;
                this.mergetmyTransportAndCourseList = [];
                this.myTransport = this.myTransport.concat(arr);
                fs.writeFileSync('./assets/lizhi/results/my-distribution.json', JSON.stringify({data: _this.myTransport}));
                let number = 1;
                _this.myTransport.forEach((item) => {
                    _this.courseList.forEach((item1) => {
                        if (item1.sameId == item.sameId) {
                            console.log('current index:', number);
                            number++;
                            let newObj = {};
                            newObj.channelNumber = item.channelNumbering;
                            newObj.bookname = item1.courseName; //课程名
                            newObj.lesson_id = item1.promoteId; //课程ID
                            newObj.images = item1.banner;       //封面图
                            newObj.origin_price = 0;            //原价
                            newObj.price = item1.price;         //定价
                            newObj.lesson_subtitle = '';        //课程副标题
                            newObj.lesson_chapter_num = 0;   //课程数
                            newObj.virtual_buynum = item.virtual_buynum;  //以售卖数量
                            newObj.teacher_income = item1.proportion; //分成比例
                            newObj.teacherid = item1.liveId;        //课程来源id
                            newObj.teacher = item1.liveName;          //作者名
                            newObj.isdiscount = 0;
                            newObj.status = item.status;            //是否有效
                            newObj.support_coupon = 0;              //是否支持优惠券
                            newObj.is_open_recommend = 0;           //是否开启推荐
                            newObj.tagId = '';
                            newObj.category_name = item1.category;
                            newObj.lesson_url = item.lesson_url;      //课程链接
                            newObj.lesson_source = '微课';
                            newObj.tweetArticle = item1.tweetArticle;
                            _this.mergetmyTransportAndCourseList.push(newObj);
                        }
                    })
                });
                tips.innerText = `我的转载列表获取完成共${_this.mergetmyTransportAndCourseList.length}条`;
                fs.writeFileSync('./assets/lizhi/results/concat.json', JSON.stringify({data: _this.mergetmyTransportAndCourseList}));
            }

            //获取教师详情
            getTeacherInfo(args) {
                const _this = this;
                if (this.teacherIndex == 0 && !this.mergetmyTransportAndCourseList.length && !this.checkIsHasMyTransport()) {
                    alert('请先获取我的转载课程再进行此操作');
                    return;
                }
                let index = this.teacherIndex - 1;
                let teacherIndex = this.teacherIndex;
                if (teacherIndex > 0) {
                    _this.mergetmyTransportAndCourseList[index]['lesson_subtitle'] = args['subtitle'];
                    _this.mergetmyTransportAndCourseList[index]['teacher'] = args['teacherName'];
                    _this.mergetmyTransportAndCourseList[index]['virtual_buynum'] = args['virtual_buynum'];
                    _this.mergetmyTransportAndCourseList[index]['lesson_chapter_num'] = args['lesson_chapter_num'];
                    var bili = _this.mergetmyTransportAndCourseList[index]['teacher_income'];
                    _this.mergetmyTransportAndCourseList[index]['teacher_income'] = bili.substring(0, bili.length - 1);
                    _this.mergetmyTransportAndCourseList[index]['teacherid'] = args['teacherid'];
                    _this.mergetmyTransportAndCourseList[index]['lectures'] = args['lectures'];
                    _this.worksheet.addRow(this.mergetmyTransportAndCourseList[index]);
                }
                if (teacherIndex < this.mergetmyTransportAndCourseList.length) {
                    _this.webview.loadURL(_this.mergetmyTransportAndCourseList[teacherIndex]['lesson_url']);
                    _this.teacherIndex = _this.teacherIndex + 1;

                    tips.innerText = `${this.mergetmyTransportAndCourseList[teacherIndex]['bookname']}(${_this.teacherIndex} /${_this.mergetmyTransportAndCourseList.length} )`;
                } else {
                    _this.finalData = _this.mergetmyTransportAndCourseList;

                    fs.writeFile('./assets/lizhi/results/Final.json', JSON.stringify({data: _this.mergetmyTransportAndCourseList}), (err) => {
                        if (err) throw err;
                    });
                    let xlsxPath;
                    dialog.showOpenDialog({title: '保存荔枝微课转载到', properties: ['openDirectory']},
                        (filePath) => {
                            if (filePath) {
                                workbook.xlsx.writeFile(`${filePath}\\我的转载-荔枝微课.xlsx`).then(function () {
                                    xlsxPath = `${filePath}\\我的转载-荔枝微课.xlsx`;
                                    tips.innerText = `我的转载-荔枝微课生成excel路径为: ${xlsxPath}`;
                                    shell.openItem(xlsxPath);
                                });
                            } else {
                                workbook.xlsx.writeFile(`${app.getPath('downloads')}\\我的转载-荔枝微课.xlsx`).then(function () {
                                    xlsxPath = `${app.getPath('downloads')}\\我的转载-荔枝微课.xlsx`;
                                    tips.innerText = `我的转载-荔枝微课生成excel路径为: ${xlsxPath}`;
                                    shell.openItem(xlsxPath);
                                });
                            }
                        });
                }
            }


            //上传到服务器
            uploadToserver() {
                const _this = this;
                if (!this.finalData.length && !this.checkFinalData()) {
                    alert('请先执行第三、第四步再执行此操作');
                    return;
                }
                new uploadJson(_this.finalData).upload();
            }
        }


        $('#close-browser').on('click', '.layui-btn', function () {
            if ($("#webview").is(':hidden')) {
                $("#webview").show();
            } else {
                $("#webview").hide();
            }
        });


        webview.addEventListener('ipc-message', (event) => {
            var args = event.args;
            if (!lizhiHandelInstance) {
                lizhiHandelInstance = new LizhiHandle(webview);
            }
            if (event.channel === "getListItem") {
                lizhiHandelInstance.getLizhiItem(args[0], args[1]);
            }
            if (event.channel === 'getListComplete') {
                lizhiHandelInstance.getLizhiComplete(args[0]);
            }

            if (event.channel == 'addLinkDone') {
                lizhiHandelInstance.createTransport();
            }

            if (event.channel == 'getMyDistributionItem') {
                tips.innerText = `第${args[1]}页已获取`;
                lizhiHandelInstance.getMyTransportItem(args[0], args[1]);
            }

            if (event.channel == 'getMyDistributionComplete') {
                lizhiHandelInstance.getMyTransportComplete(args[0]);
            }

            if (event.channel == 'getTeacherInfo') {
                lizhiHandelInstance.getTeacherInfo(args[0]);
            }
            if (event.channel == 'getQianliaoLsit') {
                tips.innerText = args[0];
                var qianliaoUpload = new uploadJson(args[1]);
                qianliaoUpload.upload();
            }
        });

        webview.addEventListener('did-finish-load', function () {
            //    webview.openDevTools();
            var Jquery = fs.readFileSync('./assets/jquery-1.8.1.min.js', {encoding: 'utf-8'});
            webview.executeJavaScript(Jquery, (results) => {
                if (webview.getURL().indexOf('m.weike.fm') > -1) {
                    let mainJs = fs.readFileSync('./assets/lizhi/main.js', {encoding: 'utf-8'});
                    webview.executeJavaScript(mainJs, (results) => {
                        console.log('执行荔枝mainjs成功')
                    })
                }
            })
        });


        $('#qianliao-step').on('click', 'button', function () {
            let step = $(this).attr('step');
            if (!qianliaoInstance) {
                qianliaoInstance = new qianliaoHandle(tips);
            }
            if (step == 'init') {
                webview.loadURL('https://m.qlchat.com/pc/knowledge-mall/index');
                $('#webview').show();
            }

            if (step == 1) {
                tips.innerText = `正在获取千聊分类课程列表`;
                qianliaoInstance.getList();
            }
            if (step == 2) {
                qianliaoInstance.createTransport();
            }
            if (step == 3) {
                qianliaoInstance.getMyTransport();
            }
            if (step == 4) {
                qianliaoInstance.uploadToServer();
            }
        });


        $('#lizhi-step').on('click', 'button', function (event) {
            let step = $(this).attr('data-step');
            if (!lizhiHandelInstance) {
                lizhiHandelInstance = new LizhiHandle(webview);
            }

            if (step == 'init') {
                webview.loadURL('https://m.weike.fm/cps/hotlist');
            }
            if (step == 1) {
                lizhiHandelInstance.courseList = [];
                webview.loadURL('https://m.weike.fm/cps/objlist');
            }
            if (step == 2) {
                lizhiHandelInstance.createTransportIndex = 0;
                layui.use('layer', function () {
                    layer.prompt({title: '请输入分销渠道备注'}, function (value, index, elem) {
                        if (!value.replace(/\s+/g, "")) {
                            return alert('请输入分销渠道备注');
                        }
                        layer.close(index);
                        remarks = value;
                        store.remarks = value;
                        lizhiHandelInstance.createTransport();
                    });
                });
            }

            if (step == 3) {
                if (!lizhiHandelInstance.courseList.length && !lizhiHandelInstance.checkIsHasCourseList()) {
                    alert('请先获取课程列表再执行此操作');
                    return;
                }
                lizhiHandelInstance.myTransport = [];
                lizhiHandelInstance.mergetmyTransportAndCourseList = [];
                lizhiHandelInstance.webview.loadURL('https://m.weike.fm/cps/sourcelist')
            }

            if (step == 4) {
                lizhiHandelInstance.teacherIndex = 0;
                lizhiHandelInstance.workbook = new Excel.Workbook();
                lizhiHandelInstance.worksheet = lizhiHandelInstance.workbook.addWorksheet('Sheet');
                lizhiHandelInstance.worksheet.columns = [
                    {header: '渠道编号', key: 'channelNumber'},
                    {header: '课程名', key: 'bookname'},
                    {header: '分类', key: 'category_name'},
                    {header: '封面图', key: 'images'},
                    {header: '价格', key: 'price'},
                    {header: '分成比例', key: 'teacher_income'},
                    {header: '推广标题', key: 'lesson_subtitle'},
                    {header: '课程数', key: 'lesson_chapter_num'},
                    {header: '购买人数', key: 'virtual_buynum'},
                    {header: '教师', key: 'teacher'},
                    {header: '文案链接', key: 'tweetArticle'},
                    {header: '课程链接', key: 'lesson_url'},
                ];
                lizhiHandelInstance.getTeacherInfo();
            }

            if (step == 5) {
                lizhiHandelInstance.uploadToserver();
            }
            $('#webview').show();
        });
    }
</script>
</body>
</html>
